---
title: ALB Service Migration Guide
categories: Upgrades
image: /assets/img/guides/refresh_icon.png
excerpt: Learn how to update your v1 Reference Architecture to use the Gruntwork Service Catalog.
tags: ["aws", "terraform", "terragrunt"]
cloud: ["aws"]
redirect_from: /static/guides/upgrades/how-to-update-your-ref-arch/
---
:page-type: guide
:page-layout: post

:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
toc::[]
endif::[]

== ALB Service Migration Guide

Follow this guide to update the ALB modules (both public and internal) to the Service Catalog.

=== Estimated Time to Migrate: 5-10 minutes per ALB

=== New Required Inputs

Configure these new inputs to migrate to the Service Catalog version of the module. They are now required.

* `vpc_id`: The VPC ID where the ALB should be located. This should be pulled in with a `dependency` block against the
`vpc-app` service, using the `vpc_id` output.
* `vpc_subnet_ids`: The IDs of the private app subnets where the ALB should be located. This should be pulled in with a
`dependency` block against the `vpc-app` service, using the `public_subnet_ids` or `private_app_subnet_ids` output
(depending on if it is a public or internal ALB).

=== Inputs for Backward Compatibility

Configure the following new inputs to ensure your service continues to function with minimal interruption. These are
necessary to maintain backward compatibility. _If left unset, you will risk redeploying the service and causing
downtime._

* `custom_tags`: Review any tags on the existing ALB and security group resource. Provide those tags in the
`custom_tags` input map. For example:

....
custom_tags = {
    Environment = "dev"
}
....

* `hosted_zone_id`: The ID of the private route53 hosted zone. This should be sourced using a `dependency` block against
the `route53-private` or `route53-public` service, using the `internal_services_hosted_zone_id` or
`primary_domain_hosted_zone_id` output (depending on if it is an internal or public ALB).
* `allow_inbound_from_security_group_ids`: A list of security group IDs that should be allowed to access the internal
ALB, such as the VPN server, or a front end application. This should be sourced using a `dependency` block also. In the
past, this wast calculated in the module, but now must be looked up with a `dependency`. Example:

....
allow_inbound_from_security_group_ids = [dependency.openvpn_server.outputs.security_group_id]
....

* `allow_inbound_from_cidr_blocks`: A list of CIDR blocks that should be allowed to access the internal ALB, such as the
CIDR range of the VPC, or of a specific list of subnets. This should be sourced using a `dependency` block also. In the
past, this was calculated in the module, but now must be looked up with a `dependency`. Example:

....
 allow_inbound_from_cidr_blocks = [dependency.vpc.outputs.vpc_cidr_block]
....

=== Renamed Inputs

Rename the following inputs to use the Service Catalog version of the module:

* `domain_name` ⇒ `domain_names`. This variable now accepts a list of strings rather than a scalar.

=== Removed Inputs

Remove the following inputs as they are not present in the Service Catalog version of the module:

* `https_listener_ports_and_ssl_certs_num`
* `https_listener_ports_and_acm_ssl_certs_num`

=== Output Changes

Update downstream dependency references to use the new names of these outputs, which were renamed in the Service Catalog
version of the module.

* `alb_dns_name` ⇒ `alb_dns_names`: Now a list of DNS names, including the friendly route53 name and the autogenerated
ALB DNS record.
* [NEW] `alb_access_logs_bucket`: The name of the ALB access logs bucket.

=== State Migration Script

Run the link:./scripts/migrate_alb.sh[provided migration script] to migrate the state in a backward compatible way.

=== Breaking Changes

* When applying the change, the bucket policy will be removed from the bucket resource and will be replaced with a new
`aws_s3_bucket_policy` resource. This policy allows ALB to deliver access logs to the S3 bucket. The existing bucket is
NOT destroyed, but the policy is recreated, which may cause a brief outage (<1 minute) in access log delivery while the
policy change occurs.
* The policy will now require the use of TLS when making requests to the access logs bucket.
* Encryption will be enabled on the bucket. This cannot be disabled.
* Public access to the bucket will be blocked. This cannot be disabled.
* If you are using `https_listener_ports_and_acm_ssl_certs` to map ports to ACM-issued TLS certificates, upon apply you
will see a change to the certificate ARN. It is now being looked up with a data source, and the change is a no-op.
