---
title: ecr-repos Service Migration Guide
categories: Upgrades
image: /assets/img/guides/refresh_icon.png
excerpt: Learn how to update your v1 Reference Architecture to use the Gruntwork Service Catalog.
tags: ["aws", "terraform", "terragrunt"]
cloud: ["aws"]
redirect_from: /static/guides/upgrades/how-to-update-your-ref-arch/
---
:page-type: guide
:page-layout: post

:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
toc::[]
endif::[]

== ecr-repos Service Migration Guide

Follow this guide to update the `ecr-repos` module to the Service Catalog.

=== Estimated Time to Migrate: 10 minutes per environment

=== Repositories Input

Configure the new `repositories` input.

This input consolidates the `repo_names`, `external_account_ids_with_read_access` and
`external_account_ids_with_write_access` inputs from the old module into a single object.

At this point you can also configure defaults for `default_external_account_ids_with_read_access` and
`default_external_account_ids_with_write_access`.

You can configure these new inputs to use the same values as what you had for the old variables.

For example, if you had:

[source,python]
----
inputs = {
  repo_names = [
    "sample-app-frontend",
    "sample-app-backend",
  ]

  external_account_ids_with_read_access = [
    "012345678901",
  ]
  external_account_ids_with_write_access = [
    "123456789012",
  ]
}
----

Convert this to:

[source,python]
----
inputs = {
  repositories = {
    "sample-app-frontend"          = {},
    "sample-app-backend"           = {},
  }

  default_external_account_ids_with_read_access = [
    "012345678901",
  ]
  default_external_account_ids_with_write_access = [
    "123456789012",
  ]
}
----

=== State Migration Script

Run the provided migration script (contents pasted below for convenience) to migrate the state in a backward compatible
way:

[source,python]
----
#!/bin/bash
# This script contains the state migration instructions for migrating ecr-repos to the Service Catalog from the old
# style Gruntwork Reference Architecture. Install this script and run it from the terragrunt live configuration
# directory of the module to perform the state operations.
#

# Import the helper functions from the repo root.
readonly infra_live_repo_root="$(git rev-parse --show-toplevel)"
source "$infra_live_repo_root/_scripts/migration_helpers.sh"

function run {
  move_state_list_to_map "aws_ecr_repository.repos" "name"
  move_state_list_to_map "aws_ecr_repository_policy.external_account_access" "id"
}

run "$@"
----

=== Breaking Changes

* This change is fully backward compatible.
