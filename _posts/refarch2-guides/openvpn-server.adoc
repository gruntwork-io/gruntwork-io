---
title: [title]
categories: Upgrades
image: /assets/img/guides/refresh_icon.png
excerpt: Learn how to update your v1 Reference Architecture to use the Gruntwork Service Catalog.
tags: ["aws", "terraform", "terragrunt"]
cloud: ["aws"]
redirect_from: /static/guides/upgrades/how-to-update-your-ref-arch/
---
:page-type: guide
:page-layout: post

:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
toc::[]
endif::[]

== OpenVPN Server service migration guide

Follow this guide to update the `openvpn-server` service to the Service Catalog.

=== Estimated Time to Migrate: 30 minutes per environment

=== New AMI

Build a new AMI using the `packer` template in the Service Catalog
(`[modules/mgmt/openvpn-server/openvpn-server.json](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/v0.28.0/modules/mgmt/openvpn-server/openvpn-server.json)`).

Follow
https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/core-concepts.md#how-to-build-amis-for-the-service-catalog[the
instructions in the Service Catalog repository] to build a new AMI, and then set the `ami` input variable to the new AMI
ID.

Note that this by itself will not rotate your existing OpenVPN server, and is thus a backward compatible change.

=== ca_cert_fields Input

Configure the new `ca_cert_fields` input.

This input consolidates the `ca_locality`, `ca_org_unit`, `ca_country`, `ca_state`, `ca_email`, `ca_org` inputs from the
old module into a single object. You can configure this new input to use the same values as what you had for the old
variables.

For example, if you had:

[source,python]
----
inputs = {
  ca_country  = "US"
  ca_state    = "AZ"
  ca_locality = "Phoenix"
  ca_org      = "rasbox"
  ca_org_unit = "IT"
  ca_email    = "support@gruntwork.io"
}
----

Convert these to use `ca_cert_fields`:

[source,python]
----
inputs = {
  ca_cert_fields = {
    ca_country  = "US"
    ca_state    = "AZ"
    ca_locality = "Phoenix"
    ca_org      = "rasbox"
    ca_org_unit = "IT"
    ca_email    = "support@gruntwork.io"
  }
}
----

=== vpn_route_cidr_blocks Input

Configure the new `vpn_route_cidr_blocks`. This should be the list of VPC CIDR blocks that the VPN has access to.

This variable was previously handled by the `current_vpc_name` and `other_vpc_names` variables. To convert to the new
`vpn_route_cidr_blocks` input, setup a new `dependency` block for each VPC name and use the `vpc_cidr_block` output. For
example, if you had:

[source,python]
----
inputs = {
  current_vpc_name = "mgmt"
  other_vpc_names = ["dev"]
}
----

Convert to:

[source,python]
----
dependency "mgmt_vpc" {
  config_path = "../vpc"
}

dependency "dev_vpc" {
  config_path = "../../dev/vpc"
}

inputs = {
  vpn_route_cidr_blocks = [
    dependency.mgmt_vpc.outputs.vpc_cidr_block,
    dependency.dev_vpc.outputs.vpc_cidr_block,
  ]
}
----

=== New Required Inputs

Configure these new inputs to migrate to the Service Catalog version of the module. They are now required.

* `vpc_id`: Set this to the ID of the VPC where the openvpn server should be deployed. This should be pulled in using a
`dependency` block against the `vpc-mgmt` service, using the `vpc_id` output.
* `subnet_ids`: Set this to the list of IDs of the VPC subnet where the openvpn server should be deployed. This should
be pulled in using a `dependency` block against the `vpc-mgmt` service, using the `public_subnet_ids` output.
* `ami_filters`: Set this to `null` . This provides an alternative mechanism to lookup the AMI to use dynamically, but
since you are providing the AMI ID directly, this variable needs to be turned off.

=== Inputs for Backward Compatibility

Configure the following new inputs to ensure your service continues to function with minimal interruption. These are
necessary to maintain backward compatibility. _If left unset, you will risk redeploying the service and causing
downtime._

* `kms_key_arn`: Set this to the CMK of the account. This is used to encrypt the backup files, and if you donâ€™t set this
correctly, the OpenVPN server will not properly restore the existing configuration. This should be pulled in with a
`[dependency` block](https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/#dependency) against
the `kms-master-key` service, using the `key_arn` output.
* `alarms_sns_topic_arns`: Set this to the ARN of the SNS topic where CloudWatch alarms should send alerts to. This
should be pulled in with a `[dependency`
block](https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/#dependency) against the `sns-topic`
service, using the `topic_arn` output.
* `hosted_zone_id`: Set this to the Route 53 Hosted Zone ID for the domain name in `domain_name`.

=== Updated Inputs

Update the following input to the new format to use the Service Catalog version of the module:

* `domain_name` => `base_domain_name`: Replace `domain_name` with `base_domain_name` and set it to the base domain name.
In the Service Catalog, this variable is no longer the full domain name and instead is the base domain name. So if you
used to have `domain_name = "vpn.example.com"`, change it to `base_domain_name = "example.com"`. The final domain name
will be `<name>.<base_domain_name>`.

=== Output Changes

The following outputs were removed due to redundancy with the input variables. Update downstream dependency references
to statically compute these values in the same way as the input variables:

* `dns_name`
* `vpn_routes`

=== State Migration Script

Run the link:./scripts/migrate_openvpn_server.sh[provided migration script] to migrate the state in a backward compatible way.

=== Breaking Changes

* *Cluster outage:* The IAM policies attached to the IAM role of the OpenVPN server need to be recreated due to a
reorganization of how the policies are attached. This means that there will be a brief outage (< 1 minute) in log
aggregation and metric reporting while the IAM policies are being recreated. This is unavoidable.
** Some resources may be destroyed:
*** `aws_iam_policy_attachment.attach_cloudwatch_metrics_policy`
*** `aws_iam_policy_attachment.attach_cloudwatch_log_aggregation_policy`
*** `aws_iam_policy.cloudwatch_metrics_read_write[0]`
