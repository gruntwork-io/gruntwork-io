---
title: VPC Service Migration Guide
categories: Upgrades
image: /assets/img/guides/refresh_icon.png
excerpt: Learn how to update your v1 Reference Architecture to use the Gruntwork Service Catalog.
tags: ["aws", "terraform", "terragrunt"]
cloud: ["aws"]
redirect_from: /static/guides/upgrades/how-to-update-your-ref-arch/
---
:page-type: guide
:page-layout: post

:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
toc::[]
endif::[]

== VPC Service Migration Guide

Follow this guide to update the VPC module to the Service Catalog.

=== Estimated Time to Migrate: 30 minutes per environment

=== New Required Inputs

Configure these new inputs to migrate to the Service Catalog version of the module. They are now required.

* `vpc_name`: Set this to the name of the VPC.

=== Inputs for Backward Compatibility

Configure the following new inputs to ensure your service continues to function with minimal interruption. These are
necessary to maintain backward compatibility. _If left unset, you will risk redeploying the service and causing
downtime._

First add a `[dependency`
block](https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/#dependency) for your management VPC.

For example, if you had the following:

[source,bash]
----
dependencies {
  paths = [
    "../../mgmt/vpc",
  ]
}
----

Convert this to:

[source,bash]
----
dependency "mgmt_vpc" {
  config_path = "../../mgmt/vpc"
}
----

Also set the following inputs:

* `create_peering_connection`: Set this to `true`
* `origin_vpc_id`: Set this to the `vpc_id` of the dependency VPC. In this example, it would be
`dependency.mgmt_vpc.outputs.vpc_id`.
* `origin_vpc_name`: Set this to the `vpc_name` of the dependency VPC. In this example, it would be
`dependency.mgmt_vpc.outputs.vpc_name`.
* `origin_vpc_cidr_block`: Set this to the `vpc_cidr_block` of the dependency VPC. In this example, it would be
`dependency.mgmt_vpc.outputs.vpc_cidr_block`.
* `origin_vpc_route_table_ids`: This is a concatenated list of outputs from the dependency VPC. In this example, it
would be
`concat( dependency.mgmt_vpc.outputs.private_subnet_route_table_ids, [dependency.mgmt_vpc.outputs.public_subnet_route_table_id] )`

=== State Migration Script

Run the provided migration script (contents pasted below for convenience) to migrate the state in a backward compatible
way:

[source,python]
----
#!/bin/bash
# This script contains the state migration instructions for migrating VPCs to the Service Catalog from the old
# style Gruntwork Reference Architecture. Install this script and run it from the terragrunt live configuration
# directory of the module to perform the state operations.
#

# Import the helper functions from the repo root.
readonly infra_live_repo_root="$(git rev-parse --show-toplevel)"
source "$infra_live_repo_root/_scripts/migration_helpers.sh"

function run {
  fuzzy_move_state \
    'mgmt_vpc_peering_connection.aws_vpc_peering_connection.vpc_peering_connection' \
    'module.vpc_peering_connection.aws_vpc_peering_connection.vpc_peering_connection[0]' \
    'VPC Peering Connection'

  fuzzy_move_state \
    'mgmt_vpc_peering_connection.aws_vpc_peering_connection_options.vpc_peering_connection_options' \
    'module.vpc_peering_connection.aws_vpc_peering_connection_options.vpc_peering_connection_options[0]' \
    'VPC Peering Connection Options'

  fuzzy_move_list \
    'mgmt_vpc_peering_connection.aws_route.origin_to_destination' \
    'vpc_peering_connection.aws_route.origin_to_destination' \
    'VPC Peering Route - Origin to Destination'

  fuzzy_move_list \
    'mgmt_vpc_peering_connection.aws_route.destination_to_origin' \
    'vpc_peering_connection.aws_route.destination_to_origin' \
    'VPC Peering Route - Destination to Origin'
}

run "$@
----

=== Breaking Changes

* This change is fully backward compatible. You will notice the creation of two resources: `aws_default_network_acl` and
`aws_default_security_group` . This can be safely ignored.
